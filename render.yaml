# Render Blueprint for Labyrinth Explorer
# Connect this repo to Render and choose this blueprint to provision the service.
# Docs: https://render.com/docs/infrastructure-as-code

services:
  - type: web
    name: labyrinth-explorer
    env: python
    plan: free
    autoDeploy: true
    region: oregon
    # Use Python 3.11 to avoid known SSL recursion issues with eventlet/pymongo on 3.13
    # Render respects runtime.txt; this comment is documentary.
    buildCommand: |
      pip install -r requirements.txt && npm ci && npm run build
    startCommand: |
      gunicorn -k uvicorn.workers.UvicornWorker -w 1 -b 0.0.0.0:$PORT web_app:asgi_app
    healthCheckPath: "/health"
    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: FLASK_ENV
        value: production
      - key: LE_ENGINE_DEBUG
        value: "0"
      - key: NODE_VERSION
        value: "20"
      - key: CORS_ALLOWED_ORIGINS
        value: "*"
      # Force Secure cookies in production (device_id cookie)
      - key: FORCE_SECURE_COOKIES
        value: "1"
      # Flask secret key (used for any secure cookies/session signing)
      - key: SECRET_KEY
        generateValue: true
      # MongoDB Atlas connection (set this in the Render dashboard or via env var sync)
      - key: MONGODB_URI
        sync: false
      - key: MONGODB_DB
        value: labyrinth
      - key: MONGODB_COLLECTION
        value: player_saves
      - key: SOCKET_TRANSPORTS
        value: websocket
      - key: ALLOW_UPGRADES
        value: "1"
      - key: SOCKETIO_ASYNC_MODE
        value: asgi
      # For WebSockets, you can enable eventlet and upgrades by setting:
      # (Already enabled above.)
      # If you scale to multiple instances, add a Redis and set:
      # - key: SOCKETIO_MESSAGE_QUEUE
      #   value: redis://:password@host:port/0
